-- V14__users_case_insensitive_unique.sql

BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE USERS DROP CONSTRAINT UQ_USERS_USERNAME';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -2443 THEN  
    RAISE;
  END IF;
END;
/
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE USERS DROP CONSTRAINT UQ_USERS_EMAIL';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -2443 THEN  
    RAISE;
  END IF;
END;
/

ALTER TABLE USERS ADD (
  USERNAME_CI GENERATED ALWAYS AS (NLSSORT(USERNAME, 'NLS_SORT=BINARY_CI')) VIRTUAL,
  EMAIL_CI    GENERATED ALWAYS AS (NLSSORT(EMAIL,    'NLS_SORT=BINARY_CI')) VIRTUAL
);

ALTER TABLE USERS ADD CONSTRAINT UQ_USERS_USERNAME_CI UNIQUE (USERNAME_CI);
ALTER TABLE USERS ADD CONSTRAINT UQ_USERS_EMAIL_CI    UNIQUE (EMAIL_CI);

