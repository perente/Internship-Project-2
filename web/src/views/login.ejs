<!DOCTYPE html>
<html lang="tr">
  <%- include('layouts/head', { title }) %>
  <body class="flex h-screen bg-gray-100">
    <%- include("layouts/sidebar") %>
    <div class="flex flex-col flex-1">
      <%- include("layouts/header") %>

      <main class="p-6">
        <div class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
          <h1 class="text-xl font-semibold mb-4 text-center">My Account</h1>

          <% if (error) { %>
          <div class="mb-4 p-3 rounded bg-red-50 text-red-700">
            <%= error %>
          </div>
          <% } %>

          <div class="grid grid-cols-2 gap-2 mb-4">
            <a
              href="/login?mode=login"
              class="text-center py-2 rounded border <%= (mode === 'login' ? 'bg-gray-100 font-semibold' : '') %>"
              >Login</a
            >
            <a
              href="/login?mode=register"
              class="text-center py-2 rounded border <%= (mode === 'register' ? 'bg-gray-100 font-semibold' : '') %>"
              >Sign Up</a
            >
          </div>

          <% if (mode === 'register') { %>
          <form
            id="registerForm"
            method="POST"
            action="http://localhost:3001/api/auth/register"
            class="space-y-4"
          >
            <div>
              <label class="block font-medium mb-1">Username</label>
              <input
                name="username"
                class="w-full border rounded p-2"
                required
              />
            </div>
            <div>
              <label class="block font-medium mb-1">Email</label>
              <input
                name="email"
                type="email"
                class="w-full border rounded p-2"
                required
              />
            </div>
            <div>
              <label class="block font-medium mb-1">Password</label>
              <input
                name="password"
                type="password"
                class="w-full border rounded p-2"
                required
              />
            </div>
            <button class="w-full px-4 py-2 rounded bg-blue-600 text-white">
              Sign Up
            </button>
          </form>
          <% } else { %>
          <form
            id="loginForm"
            method="POST"
            action="http://localhost:3001/api/auth/login"
            class="space-y-4"
          >
            <div>
              <label class="block font-medium mb-1"
                >Username or Email</label
              >
              <input
                name="userOrEmail"
                class="w-full border rounded p-2"
                required
              />
            </div>
            <div>
              <label class="block font-medium mb-1">Åžifre</label>
              <input
                name="password"
                type="password"
                class="w-full border rounded p-2"
                required
              />
            </div>
            <button class="w-full px-4 py-2 rounded bg-blue-600 text-white">
              Login
            </button>
            <p class="text-sm text-gray-600 text-center">
              Don't have an account?
              <a class="underline" href="/login?mode=register">Sign Up</a>
            </p>
          </form>
          <% } %>
        </div>
        <script>
          async function postJson(form, url) {
            const fd = new FormData(form);
            const body = {};
            fd.forEach((v, k) => (body[k] = v));

            const r = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(body),
            });
            return r.json();
          }

          function showError(msg) {
            let box = document.querySelector("#errBox");
            if (!box) {
              box = document.createElement("div");
              box.id = "errBox";
              box.className = "mb-4 p-3 rounded bg-red-50 text-red-700";
              const container = document.querySelector("h1")?.parentElement;
              container?.insertBefore(box, container.children[1]);
            }
            box.textContent = msg;
          }

          const loginForm = document.getElementById("loginForm");
          if (loginForm) {
            loginForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const data = await postJson(loginForm, loginForm.action);
              if (data.ok) location.href = "/";
              else showError(data.error || "Login failed");
            });
          }

          const registerForm = document.getElementById("registerForm");
          if (registerForm) {
            registerForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const data = await postJson(registerForm, registerForm.action);
              if (data.ok) location.href = "/";
              else showError(data.error || "Sign Up failed");
            });
          }
        </script>
      </main>
    </div>
  </body>
</html>
