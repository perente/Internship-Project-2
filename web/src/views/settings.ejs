<!DOCTYPE html>
<html lang="en">
<%- include('layouts/head', {title: "Settings"}) %>
<body class="flex h-screen bg-gray-100">
<%- include("layouts/sidebar") %>

<div class="flex flex-col flex-1">
  <%- include("layouts/header", {user: user}) %>

  <main class="p-6 overflow-auto">
    <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg">
      <% const createdAtDisp = user ? (user.created_at_display || user.createdAtDisplay) : null; %>

      <h2 class="text-3xl font-bold mb-6 flex items-baseline justify-between">
        <span>Profile Settings</span>
        <% if (createdAtDisp) { %>
          <span class="text-sm font-normal text-gray-500">
            Profile created at: <%= createdAtDisp %>
          </span>
        <% } %>
      </h2>

      <form action="http://localhost:3001/api/auth/update_settings" method="POST" enctype="multipart/form-data" class="space-y-6">
        <% if (typeof error !== "undefined" && error) { %>
          <div class="mb-4 p-3 rounded bg-red-50 text-red-700"><%= error %></div>
        <% } %>
        <% if (typeof ok !== "undefined" && ok) { %>
          <div class="mb-4 p-3 rounded bg-green-50 text-green-700"><%= ok %></div>
        <% } %>

        <input type="hidden" name="id" value="<%= user ? user.id : '' %>" />

          <div class="flex flex-col items-center mb-6">
            <% const avatarPath = user && user.id ? '/uploads/' + user.id + '.webp' : '/img/default.webp'; %>
            <div class="relative">
              <div class="w-32 h-32 rounded-full overflow-hidden shadow-md border-4 border-white cursor-pointer" id="avatarWrapper">
                <img id="avatarImg" src="<%= avatarPath %>" onerror="this.onerror=null;this.src='/img/default.webp'" class="w-full h-full object-cover" />
              </div>
              <input id="avatarInput" name="avatar" type="file" accept="image/*" class="hidden" />
            </div>
            <p class="mt-2 text-gray-500 text-sm text-center">Click for change profile photo</p>
          </div>


          <div>
          <label for="username" class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
          <input
                  type="text"
                  id="username"
                  name="username"
                  placeholder="<%= user ? user.username : '' %>"
                  value="<%= user ? user.username : '' %>"
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div>
          <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
          <input
                  type="email"
                  id="email"
                  name="email"
                  placeholder="<%= user ? user.email : '' %>"
                  value="<%= user ? user.email : '' %>"
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div>
          <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Change Password</label>
          <input
                  type="password"
                  id="password"
                  name="password"
                  placeholder="Leave empty if you don't want to change"
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div class="pt-4">
          <button
                  type="submit"
                  class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition"
          >
            Save
          </button>
        </div>

        <% if (typeof error !== "undefined" && error) { %>
          <div class="mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-sm">
            <%= error %>
          </div>
        <% } %>
        <% if (typeof success !== "undefined" && success) { %>
          <div class="mt-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-sm">
            <%= success %>
          </div>
        <% } %>
      </form>
    </div>
  </main>
</div>

<script>
  (function () {
    const avatarImg = document.getElementById('avatarImg');
    const avatarInput = document.getElementById('avatarInput');
    const avatarWrapper = document.getElementById('avatarWrapper');

    avatarWrapper.addEventListener('click', function () {
      avatarInput.click();
    });

    avatarInput.addEventListener('change', function (e) {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      avatarImg.src = url;
    });
  })();
</script>
</body>
</html>
